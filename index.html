<!DOCTYPE html>  
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI作文引導單 - 教師設定</title>
    
    <link rel="stylesheet" href="style.css">

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: #f4f7f9; color: #333; line-height: 1.6; margin: 0; padding: 20px;
        }
        .container {
            max-width: 1000px; margin: 0 auto; background: #fff; padding: 25px 40px;
            border-radius: 12px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        h1 { font-size: 2em; text-align: center; margin-bottom: 20px; color: #0056b3; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: 500; }
        .form-group input[type="text"], .form-group select, .form-group input[type="number"] {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
        }
        .form-group textarea {
            width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;
            font-family: inherit;
        }
        .button-primary {
            display: inline-block; padding: 10px 18px; font-size: 0.95em;
            background-color: #007bff; color: white; border: none; border-radius: 8px; cursor: pointer;
            transition: background-color 0.3s;
        }
        .button-primary:hover { background-color: #0056b3; }

        fieldset {
            border: 3px solid #4a90e2;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 25px;
        }
        legend {
            font-size: 1.4em;
            font-weight: bold;
            color: #4a90e2;
            padding: 0 15px;
        }
        .option-group {
            padding: 20px;
            margin-top: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.08);
            border: 1px solid #e0e0e0;
        }
        .group-vocabulary { background-color: #e7f3fe; }
        .group-rhetoric { background-color: #e8f5e9; }
        .group-sentence-patterns { background-color: #fffbe6; }
        .option-group h3 { margin-top: 0; margin-bottom: 15px; }
        
        .compound-sentence-option { 
            margin-top: 15px; 
            padding: 10px;
            border-bottom: 1px solid #ddd;
        }
        .compound-sentence-option:last-child {
            border-bottom: none;
        }
        .compound-sentence-option label {
            font-weight: bold;
            display: inline-block;
            margin-bottom: 0;
            cursor: pointer;
            color: #2c3e50;
        }
        .connectives-list { 
            margin-top: 10px; 
            padding-left: 20px; 
            display: none; 
        }
        .connectives-list label { 
            font-weight: normal; 
            margin-right: 15px; 
            margin-top: 5px; 
        }

        .form-row {
            display: flex;
            gap: 20px;
            align-items: flex-start;
        }
        .form-row .form-group {
            max-width: 49%;
            flex: 0 0 49%;
        }

        /* 下方產生連結區塊置中 */
        #student-links-section {
            text-align: center;
        }
        #student-links-list {
            list-style-type: none;
            padding-left: 0;
            margin: 10px auto 0 auto;
            text-align: left;
            display: inline-block;
        }
        #export-buttons {
            margin-top: 16px;
            display: flex;
            justify-content: center;
        }
        #export-buttons .button-primary[disabled] {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>AI作文引導單 - 教師設定 ✍️</h1>
        <p>請為您的學生設定作文引導單，完成後點擊生成按鈕即可。系統會依照人數自動產生學生專用連結。</p>
        
        <form id="configForm">
            <fieldset>
                <legend>作文基本設定</legend>
                
                <div class="form-group">
                    <label for="title">作文題目</label>
                    <input type="text" id="title" required placeholder="例如：我最難忘的一次旅行">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="level">學生年級</label>
                        <select id="level">
                            <option value="三年級">三年級</option>
                            <option value="四年級">四年級</option>
                            <option value="五年級">五年級</option>
                            <option value="六年級">六年級</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="wordCount">字數要求</label>
                        <select id="wordCount">
                            <option value="150字">150字</option>
                            <option value="300字">300字</option>
                            <option value="400字">400字</option>
                            <option value="500字">500字</option>
                            <option value="600字">600字</option>                        
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label for="style">作文文體</label>
                        <select id="style">
                            <option value="記敘文本(記物)">記敘文本(記物)</option>
                            <option value="記敘文本(記人)">記敘文本(記人)</option>
                            <option value="記敘文本(記事)">記敘文本(記事)</option>
                            <option value="記敘文本(記景)">記敘文本(記景)</option>
                            <option value="應用文本(書信)">應用文本(書信)</option>
                            <option value="說明文本">說明文本</option>
                            <option value="議論文本">議論文本</option>
                            <option value="抒情文本">抒情文本</option>
                            <option value="詩歌">詩歌</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="structure">作文結構</label>
                        <select id="structure">
                            <option value="起承轉合式">起承轉合式</option>
                            <option value="時間順序式(順敘法)">時間順序式(順敘法)</option>
                            <option value="時間順序式(倒敘法)">時間順序式(倒敘法)</option>
                            <option value="總分總式">總分總式</option>
                        </select>
                    </div>
                </div>
                <!-- 新增：學生人數 / 每組 API Key 人數 -->
                <div class="form-row">
                    <div class="form-group">
                        <label for="totalStudents">學生人數</label>
                        <input type="number" id="totalStudents" min="1" max="60" value="32">
                    </div>
                    <div class="form-group">
                        <label for="studentsPerKey">每組 API Key 對應人數</label>
                        <input type="number" id="studentsPerKey" min="1" max="10" value="4">
                        <small style="color:#666;">建議 3～5 位學生共用一組 API Key。</small>
                    </div>
                </div>

                <!-- API Key 列表 -->
                <div class="form-group">
                    <label for="apikey-list">Gemini API Key 列表（每行一組）</label>
                    <textarea id="apikey-list" rows="6" placeholder="每行貼上一組 Gemini API Key（請勿貼 sk-proj- 開頭的金鑰）"></textarea>
                    <small id="apikey-hint" style="color:#666;"></small>
                </div>
            </fieldset>

            <fieldset>
                <legend>作文進階指導選項 (可複選)</legend>
                
                <div class="form-group-checkbox option-group group-vocabulary">
                    <h3>建議詞彙</h3>
                    <label><input type="checkbox" name="phrases_vocab" value="語詞"> 語詞</label>
                    <label><input type="checkbox" name="phrases_idioms" value="成語"> 成語</label>
                    <label><input type="checkbox" name="phrases_quotes" value="名言佳句"> 名言佳句</label>
                    <label><input type="checkbox" name="phrases_personality" value="性格卡"> 性格卡</label>
                    <label><input type="checkbox" name="phrases_emotion" value="情緒卡"> 情緒卡</label>
                </div>

                <div class="form-group-checkbox option-group group-rhetoric">
                    <h3>建議修辭</h3>
                    <label><input type="checkbox" name="rhetoric" value="譬喻"> 譬喻</label>
                    <label><input type="checkbox" name="rhetoric" value="擬人"> 擬人</label>
                    <label><input type="checkbox" name="rhetoric" value="誇飾"> 誇飾</label>
                    <label><input type="checkbox" name="rhetoric" value="類疊"> 類疊</label>
                    <label><input type="checkbox" name="rhetoric" value="排比"> 排比</label>
                    <label><input type="checkbox" name="rhetoric" value="雙關"> 雙關</label>
                    <label><input type="checkbox" name="rhetoric" value="映襯"> 映襯</label>
                    <label><input type="checkbox" name="rhetoric" value="摹寫"> 摹寫</label>
                </div>
                
                <div class="option-group group-sentence-patterns">
                    <h3>建議句型</h3>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="binglie-list"> 
                            並列複句
                        </label>
                        <div id="binglie-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="也"> 也</label>
                            <label><input type="checkbox" name="conjunctions" value="又"> 又</label>
                            <label><input type="checkbox" name="conjunctions" value="既又"> 既……又……</label>
                            <label><input type="checkbox" name="conjunctions" value="一方面另一方面"> 一方面……另一方面……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="zhuanzhe-list"> 
                            轉折複句
                        </label>
                        <div id="zhuanzhe-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="雖然但是"> 雖然……但是……</label>
                            <label><input type="checkbox" name="conjunctions" value="雖然卻"> 雖然……卻……</label>
                            <label><input type="checkbox" name="conjunctions" value="不過"> 不過</label>
                            <label><input type="checkbox" name="conjunctions" value="然而"> 然而</label>
                            <label><input type="checkbox" name="conjunctions" value="可是"> 可是</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="yinguo-list"> 
                            因果複句
                        </label>
                        <div id="yinguo-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="因此"> 因此</label>
                            <label><input type="checkbox" name="conjunctions" value="因為所以"> 因為……所以……</label>
                            <label><input type="checkbox" name="conjunctions" value="既然就"> 既然……就……</label>
                            <label><input type="checkbox" name="conjunctions" value="既然那麼"> 既然……那麼……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="dijin-list"> 
                            遞進複句
                        </label>
                        <div id="dijin-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="更"> 更</label>
                            <label><input type="checkbox" name="conjunctions" value="並且"> 並且</label>
                            <label><input type="checkbox" name="conjunctions" value="不但而且"> 不但……而且……</label>
                            <label><input type="checkbox" name="conjunctions" value="不僅還"> 不僅……還……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="tiaojian-list"> 
                            條件複句
                        </label>
                        <div id="tiaojian-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="只要就"> 只要……就……</label>
                            <label><input type="checkbox" name="conjunctions" value="只有才"> 只有……才……</label>
                            <label><input type="checkbox" name="conjunctions" value="除非才"> 除非……才……</label>
                            <label><input type="checkbox" name="conjunctions" value="無論都"> 無論……都……</label>
                            <label><input type="checkbox" name="conjunctions" value="任憑都"> 任憑……都……</label>
                            <label><input type="checkbox" name="conjunctions" value="不管也"> 不管……也……</label>
                            <label><input type="checkbox" name="conjunctions" value="不論總"> 不論……總……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="mudi-list"> 
                            目的複句
                        </label>
                        <div id="mudi-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="為了"> 為了</label>
                            <label><input type="checkbox" name="conjunctions" value="以便"> 以便</label>
                            <label><input type="checkbox" name="conjunctions" value="免得"> 免得</label>
                            <label><input type="checkbox" name="conjunctions" value="以免"> 以免</label>
                            <label><input type="checkbox" name="conjunctions" value="為了起見"> 為了……起見……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="chengjie-list"> 
                            承接複句
                        </label>
                        <div id="chengjie-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="於是"> 於是</label>
                            <label><input type="checkbox" name="conjunctions" value="然後"> 然後</label>
                            <label><input type="checkbox" name="conjunctions" value="接著"> 接著</label>
                            <label><input type="checkbox" name="conjunctions" value="後來"> 後來</label>
                            <label><input type="checkbox" name="conjunctions" value="便"> 便</label>
                            <label><input type="checkbox" name="conjunctions" value="一就"> 一……就……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="jiashen-list"> 
                            假設複句
                        </label>
                        <div id="jiashen-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="假如"> 假如</label>
                            <label><input type="checkbox" name="conjunctions" value="假使"> 假使</label>
                            <label><input type="checkbox" name="conjunctions" value="假若"> 假若</label>
                            <label><input type="checkbox" name="conjunctions" value="要是"> 要是</label>
                            <label><input type="checkbox" name="conjunctions" value="如果就"> 如果……就……</label>
                            <label><input type="checkbox" name="conjunctions" value="倘若那麼"> 倘若……那麼……</label>
                            <label><input type="checkbox" name="conjunctions" value="就是也"> 就是……也……</label>
                        </div>
                    </div>
                    <div class="compound-sentence-option">
                        <label>
                            <input type="checkbox" class="sentence-pattern-toggle" data-target="xuanze-list"> 
                            選擇複句
                        </label>
                        <div id="xuanze-list" class="connectives-list">
                            <label><input type="checkbox" name="conjunctions" value="要麼要麼"> 要麼……要麼……</label>
                            <label><input type="checkbox" name="conjunctions" value="或者或者"> 或者……或者……</label>
                            <label><input type="checkbox" name="conjunctions" value="是還是"> 是……還是……</label>
                            <label><input type="checkbox" name="conjunctions" value="不是就是"> 不是……就是……</label>
                            <label><input type="checkbox" name="conjunctions" value="與其不如"> 與其……不如……</label>
                        </div>
                    </div>
                </div>

                <div class="form-group-checkbox option-group" style="background-color: #fce7f6;">
                    <h3>生成範文</h3>
                    <label>
                        <input type="checkbox" name="generate_example_essay" value="true"> 
                        提供一篇完整文章作為靈感輔助
                    </label>
                </div>

                <!-- 生成按鈕置中 -->
                <div style="text-align:center; margin-top:20px;">
                    <button type="submit" class="button-primary">
                        生成學生連結
                    </button>
                </div>
            </fieldset>
        </form>
    </div>

    <!-- 顯示學生連結的區塊（置中） -->
    <div id="student-links-section" class="container" style="margin-top: 20px; display: none;">
        <h2 id="links-title" style="font-size:1.5em; color:#0056b3; margin-bottom:10px;">
            <!-- 文字會由 JS 動態填入 -->
        </h2>
        <p id="links-desc" style="color:#555; margin-bottom:10px;">
            <!-- 文字會由 JS 動態填入 -->
        </p>

        <ol id="student-links-list"></ol>

        <!-- 只保留 Excel 匯出按鈕 -->
        <div id="export-buttons">
            <button id="export-links-xlsx" type="button" class="button-primary" disabled>
                下載 Excel 名單 (.xlsx)
            </button>
        </div>
    </div>

    <!-- SheetJS：用來產生真正的 xlsx 檔 -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<script>
    let generatedStudentLinks = [];

    document.addEventListener('DOMContentLoaded', () => {
        const chineseDigits = {
            0: '零', 1: '一', 2: '二', 3: '三', 4: '四',
            5: '五', 6: '六', 7: '七', 8: '八', 9: '九', 10: '十'
        };

        function numberToChinese(num) {
            // 簡單版：支援 1~20，超過 20 就用阿拉伯數字
            if (num <= 10) return chineseDigits[num] || String(num);
            if (num < 20) return '十' + (num === 10 ? '' : chineseDigits[num - 10]);
            if (num === 20) return '二十';
            return String(num); // >20 時直接用阿拉伯數字
        }

        function getConfigNumbers() {
            const totalStudentsInput = document.getElementById('totalStudents');
            const perKeyInput = document.getElementById('studentsPerKey');

            let totalStudents = parseInt(totalStudentsInput.value, 10);
            let studentsPerKey = parseInt(perKeyInput.value, 10);

            if (!Number.isFinite(totalStudents) || totalStudents <= 0) totalStudents = 1;
            if (!Number.isFinite(studentsPerKey) || studentsPerKey <= 0) studentsPerKey = 1;

            return { totalStudents, studentsPerKey };
        }

        function updateApiKeyHint() {
            const { totalStudents, studentsPerKey } = getConfigNumbers();
            const groups = Math.ceil(totalStudents / studentsPerKey);
            const hintEl = document.getElementById('apikey-hint');
            hintEl.textContent = `目前設定：${totalStudents} 位學生，每組 API Key 對應 ${studentsPerKey} 人，最少需要 ${groups} 組 API Key（請貼上至少 ${groups} 行金鑰）。`;
        }

        updateApiKeyHint();
        document.getElementById('totalStudents').addEventListener('input', updateApiKeyHint);
        document.getElementById('studentsPerKey').addEventListener('input', updateApiKeyHint);

        // 複句顯示/隱藏
        const toggles = document.querySelectorAll('.sentence-pattern-toggle');
        toggles.forEach(toggle => {
            toggle.addEventListener('change', function() {
                const targetId = this.getAttribute('data-target');
                const targetElement = document.getElementById(targetId);
                if (!targetElement) return;
                if (this.checked) {
                    targetElement.style.display = 'block';
                } else {
                    targetElement.style.display = 'none';
                    targetElement.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                }
            });
        });

        document.getElementById('configForm').addEventListener('submit', function(event) {
            event.preventDefault();

            const { totalStudents, studentsPerKey } = getConfigNumbers();

            // 檢查題目
            const titleValue = document.getElementById('title').value.trim();
            if (!titleValue) {
                alert('請務必填寫作文題目！');
                document.getElementById('title').focus();
                return;
            }

            // 檢查人數設定
            if (totalStudents <= 0) {
                alert('學生人數必須大於 0。');
                return;
            }
            if (studentsPerKey <= 0) {
                alert('每組 API Key 對應人數必須大於 0。');
                return;
            }

            const minKeysNeeded = Math.ceil(totalStudents / studentsPerKey);

            // 讀取 API Key 列表
            const rawKeyText = document.getElementById('apikey-list').value || "";
            const apiKeys = rawKeyText
                .split(/\r?\n/)
                .map(line => line.trim())
                .filter(line => line.length > 0);

            if (apiKeys.length < minKeysNeeded) {
                alert(`目前設定的學生人數與分配，每組 ${studentsPerKey} 人，共需要至少 ${minKeysNeeded} 組 API Key。\n請再多貼一些金鑰。`);
                document.getElementById('apikey-list').focus();
                return;
            }

            // 收集引導單設定
            const params = new URLSearchParams();
            params.set('title', titleValue);
            params.set('level', document.getElementById('level').value);
            params.set('wordCount', document.getElementById('wordCount').value);
            params.set('style', document.getElementById('style').value);
            params.set('structure', document.getElementById('structure').value);
            
            const getCheckedValues = (name) => {
                return Array.from(
                    document.querySelectorAll(`input[name="${name}"]:checked`)
                ).map(cb => cb.value);
            };

            const dynamicCategories = [
                'phrases_vocab', 'phrases_idioms', 'phrases_quotes', 
                'phrases_personality', 'phrases_emotion', 'conjunctions', 'rhetoric'
            ];
            
            dynamicCategories.forEach(name => {
                const values = getCheckedValues(name);
                if (values.length > 0) {
                    params.set(name, values.join(','));
                }
            });

            const generateExample = getCheckedValues('generate_example_essay');
            if (generateExample.includes('true')) {
                params.set('generate_example_essay', 'true');
            }

            const baseQuery = params.toString();

            // 建立學生連結
            const linksSection = document.getElementById('student-links-section');
            const linksList = document.getElementById('student-links-list');
            const linksTitle = document.getElementById('links-title');
            const linksDesc = document.getElementById('links-desc');

            linksList.innerHTML = '';
            generatedStudentLinks = [];

            const seatDigits = String(totalStudents).length;
            const firstSeatId = String(1).padStart(seatDigits, '0');
            const lastSeatId = String(totalStudents).padStart(seatDigits, '0');

            linksTitle.textContent = `已產生 ${totalStudents} 個學生專用連結（${firstSeatId}～${lastSeatId} 號）`;
            linksDesc.textContent = `說明：每組 API Key 對應 ${studentsPerKey} 位學生，系統會依座號順序分配第 1 組、第 2 組……金鑰。`;

            for (let i = 1; i <= totalStudents; i++) {
                const seatId = String(i).padStart(seatDigits, '0');
                const keyIndex = Math.floor((i - 1) / studentsPerKey); 
                const apiKeyForThisStudent = apiKeys[keyIndex];
                const groupNumber = keyIndex + 1;
                const groupChinese = numberToChinese(groupNumber);

                const url = `student_tool.html?${baseQuery}&sid=${seatId}#apikey=${encodeURIComponent(apiKeyForThisStudent)}`;

                const li = document.createElement('li');
                li.style.marginBottom = '6px';
                li.innerHTML = `
                    <strong>第 ${seatId} 號學生</strong>
                    （第 ${groupChinese} 組）：
                    <a href="${url}" target="_blank" rel="noopener">
                        開啟學生引導單
                    </a>
                `;
                linksList.appendChild(li);

                generatedStudentLinks.push({
                    seatId,
                    groupNumber,
                    groupChinese,
                    apiKey: apiKeyForThisStudent,
                    url
                });
            }

            linksSection.style.display = 'block';

            const btn = document.getElementById('export-links-xlsx');
            if (btn) btn.disabled = generatedStudentLinks.length === 0;
        });

        // Excel(.xlsx) 匯出：使用 SheetJS 產生真正的 Excel 檔，連結可點擊
        document.getElementById('export-links-xlsx').addEventListener('click', () => {
            if (!generatedStudentLinks.length) return;

            const wb = XLSX.utils.book_new();
            const wsData = [['座號', 'API Key 組別', '連結']];

            // 取當前 teacher.html 所在目錄作為 base（不管是在 GitHub Pages 或本機）
            const baseUrl = new URL('.', window.location.href).href;

            const linkTargets = [];

            generatedStudentLinks.forEach(item => {
                const absoluteUrl = new URL(item.url, baseUrl).href;

                wsData.push([
                    item.seatId,
                    `第${item.groupChinese}組`,
                    '開啟學生引導單'  // 先寫文字，待會再補超連結
                ]);

                linkTargets.push(absoluteUrl);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // 補上超連結
            for (let i = 0; i < linkTargets.length; i++) {
                const row = i + 2; // 資料從第 2 列開始
                const cellAddress = 'C' + row;
                if (!ws[cellAddress]) {
                    ws[cellAddress] = { t: 's', v: '開啟學生引導單' };
                }
                ws[cellAddress].l = { Target: linkTargets[i] };
            }

            const lastSeatId = generatedStudentLinks[generatedStudentLinks.length - 1].seatId;
            const fileName = `student_links_01-${lastSeatId}.xlsx`;

            XLSX.utils.book_append_sheet(wb, ws, '學生連結名單');
            XLSX.writeFile(wb, fileName);
        });
    });
</script>
</body>
</html>
